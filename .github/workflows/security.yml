name: Security Pipeline

on:
  push:
    branches: [main, master, security-lab]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  # Job 1: Secret Detection
  secrets:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: Dependency Vulnerabilities
  dependencies:
    name: Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install --package-lock-only
      
      - uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scanners: 'vuln'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          exit-code: '1'

  # Job 3: Container Scan
  container:
    name: Container Scan
    runs-on: ubuntu-latest
    if: hashFiles('**/Dockerfile') != ''
    steps:
      - uses: actions/checkout@v4
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: app:scan
      
      - uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          image-ref: 'app:scan'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          exit-code: '1'

  # Job 4: IaC Scan
  infrastructure:
    name: IaC Scan
    runs-on: ubuntu-latest
    if: hashFiles('**/*.tf') != ''
    steps:
      - uses: actions/checkout@v4
      
      - uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scanners: 'misconfig'
          severity: 'CRITICAL,HIGH,MEDIUM'
          format: 'table'
          exit-code: '1'

  # Job 5: Security Gate
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [secrets, dependencies, container, infrastructure]
    if: always()
    steps:
      - name: Evaluate Results
        run: |
          echo "=== Security Gate Results ==="
          
          failed=0
          
          check_result() {
            local name=$1
            local result=$2
            if [ "$result" == "failure" ]; then
              echo "‚ùå $name: FAILED"
              failed=1
            elif [ "$result" == "success" ]; then
              echo "‚úÖ $name: PASSED"
            else
              echo "‚è≠Ô∏è $name: SKIPPED"
            fi
          }
          
          check_result "Secrets" "${{ needs.secrets.result }}"
          check_result "Dependencies" "${{ needs.dependencies.result }}"
          check_result "Container" "${{ needs.container.result }}"
          check_result "Infrastructure" "${{ needs.infrastructure.result }}"
          
          echo "=============================="
          
          if [ $failed -eq 1 ]; then
            echo "üö´ Security Gate: FAILED"
            exit 1
          fi
          
          echo "‚úÖ Security Gate: PASSED"
